<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>K-Studio PRO | BTS Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <style>
      [x-cloak] {
        display: none !important;
      }
      body {
        background: #000;
        color: white;
        overflow-x: hidden;
        /* Impede scroll el√°stico no iOS */
        position: fixed;
        width: 100%;
        height: 100%;
      }
      /* Efeito Neon na Borda da Live */
      .live-canvas {
        border: 2px solid #ff1493;
        box-shadow: 0 0 20px rgba(255, 20, 147, 0.2);
      }
      /* Legendas com borda grossa para leitura f√°cil */
      .subtitle-overlay {
        text-shadow: 3px 3px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000,
          -1px 1px 0 #000, 1px 1px 0 #000;
        font-weight: 900;
        font-family: "Arial", sans-serif;
        pointer-events: none; /* Deixa clicar no v√≠deo atrav√©s da legenda */
      }

      /* Anima√ß√£o do Chat */
      .chat-bubble {
        box-shadow: 0 4px 15px rgba(109, 40, 217, 0.6);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      }

      .ui-fade {
        transition: all 0.5s ease-in-out;
      }

      /* Ajuste Mobile */
      @media (max-width: 768px) {
        .sidebar {
          position: fixed;
          bottom: 0;
          width: 100%;
          height: auto;
          z-index: 50;
        }
        /* Legendas maiores no mobile para facilitar leitura em telas pequenas */
        .subtitle-overlay {
          font-size: 1.5rem;
          line-height: 1.2;
          padding: 0 10px;
        }
      }
    </style>
    <script>
      // Configura√ß√£o do Tailwind para as cores do BTS
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              army: "#8A2BE2", // Roxo Army
            },
          },
        },
      };
    </script>
  </head>
  <body x-data="studioManager()" @click="resumeAudioContext()">
    <aside
      x-show="!isCapturing"
      x-transition:leave="opacity-0 -translate-x-full"
      class="ui-fade fixed left-0 top-0 w-full md:w-80 h-full bg-zinc-950/98 z-50 p-6 border-r border-purple-900/30 flex flex-col shadow-2xl"
    >
      <div class="flex items-center gap-2 mb-8">
        <div
          class="w-8 h-8 bg-army rounded-sm flex items-center justify-center rotate-45"
        >
          <span class="text-white font-black -rotate-45 text-xs">K</span>
        </div>
        <h1
          class="text-white font-black italic text-xl uppercase tracking-tighter"
        >
          K-Studio <span class="text-army">ARMY</span>
        </h1>
      </div>

      <div class="space-y-6">
        <div>
          <label
            class="text-[10px] uppercase font-bold text-zinc-500 tracking-widest"
            >Link da Live (YouTube)</label
          >
          <input
            x-model="liveUrl"
            type="text"
            class="w-full bg-zinc-900 border border-purple-900/50 rounded-xl p-4 text-sm mt-2 outline-none focus:border-army focus:ring-1 focus:ring-army transition-all placeholder-zinc-700"
            placeholder="Cole o link aqui..."
          />
        </div>

        <button
          @click="toggleCapture"
          class="w-full py-4 bg-gradient-to-r from-purple-700 to-army hover:from-purple-600 hover:to-purple-500 rounded-2xl font-bold uppercase shadow-lg shadow-purple-900/40 active:scale-95 transition-all flex items-center justify-center gap-2"
        >
          <span>Iniciar Transmiss√£o</span>
          <div
            x-show="!wsConnected"
            class="w-2 h-2 bg-red-500 rounded-full animate-pulse"
          ></div>
        </button>

        <p
          class="text-[9px] text-zinc-500 text-center uppercase tracking-widest leading-relaxed"
        >
          Para gravar no iPhone: Use o microfone.<br />
          No PC: Use "Guia do Chrome" para √°udio limpo.
        </p>
      </div>

      <div
        class="mt-auto p-4 bg-purple-900/10 rounded-2xl border border-purple-900/20"
      >
        <div class="flex items-center justify-between">
          <span class="text-[10px] uppercase font-bold text-zinc-400"
            >Status do Servidor</span
          >
          <div class="flex items-center gap-2">
            <span
              x-text="wsConnected ? 'ONLINE' : 'OFFLINE'"
              class="text-[10px] font-bold"
              :class="wsConnected ? 'text-green-500' : 'text-red-500'"
            ></span>
            <div
              :class="wsConnected ? 'bg-green-500 shadow-[0_0_8px_#22c55e]' : 'bg-red-500'"
              class="w-2 h-2 rounded-full"
            ></div>
          </div>
        </div>
      </div>
    </aside>

    <main
      class="w-screen h-screen bg-black flex items-center justify-center relative overflow-hidden"
    >
      <div class="relative w-full h-full flex flex-col">
        <template x-if="liveUrl">
          <iframe
            class="w-full h-full object-cover"
            :src="getEmbedUrl(liveUrl)"
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
            allowfullscreen
          ></iframe>
        </template>

        <template x-if="!liveUrl">
          <div
            class="w-full h-full flex flex-col items-center justify-center text-zinc-800"
          >
            <p class="text-6xl font-black opacity-20">K-LIVE</p>
            <p class="text-sm mt-2 opacity-40">Aguardando link...</p>
          </div>
        </template>

        <div
          class="absolute bottom-24 md:bottom-24 w-full px-4 md:px-16 text-center z-40 pointer-events-none"
        >
          <div
            x-show="currentSubtitle"
            x-transition:enter="transition ease-out duration-300"
            x-transition:enter-start="opacity-0 translate-y-4"
            x-transition:enter-end="opacity-100 translate-y-0"
            class="subtitle-overlay text-2xl md:text-4xl lg:text-5xl leading-snug inline-block text-yellow-300"
            x-text="currentSubtitle"
          ></div>
        </div>

        <button
          x-show="isCapturing"
          @click="stopRecording()"
          class="absolute top-6 left-6 w-10 h-10 bg-white/10 backdrop-blur-md rounded-full z-50 flex items-center justify-center text-white/50 hover:bg-red-500/80 hover:text-white transition-all shadow-lg"
        >
          ‚úï
        </button>

        <div class="fixed bottom-6 right-6 z-50 flex flex-col items-end">
          <div
            x-show="chatOpen"
            x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 translate-y-10 scale-90"
            class="bg-zinc-900/95 backdrop-blur-xl border border-purple-500/30 w-[85vw] md:w-80 mb-4 rounded-3xl overflow-hidden shadow-2xl shadow-purple-900/50"
          >
            <div
              class="bg-gradient-to-r from-purple-800 to-army p-4 text-xs font-bold flex justify-between items-center text-white"
            >
              <span class="flex items-center gap-2"> üá∞üá∑ TRADUTOR F√É </span>
              <button
                @click="chatOpen = false"
                class="hover:text-purple-200 p-2"
              >
                ‚úï
              </button>
            </div>

            <div class="p-4 space-y-3">
              <textarea
                x-model="userComment"
                class="w-full bg-black/50 border border-zinc-700 rounded-xl p-3 text-sm text-white outline-none focus:border-army placeholder-zinc-600 resize-none"
                rows="3"
                placeholder="Escreva sua mensagem para o Idol..."
              ></textarea>

              <button
                @click="translateComment"
                class="w-full py-3 bg-white text-purple-900 hover:bg-zinc-200 rounded-xl text-xs font-bold uppercase tracking-widest transition-colors flex items-center justify-center gap-2"
                :disabled="loadingTranslate || !userComment"
                :class="{'opacity-50 cursor-not-allowed': loadingTranslate || !userComment}"
              >
                <span x-show="loadingTranslate" class="animate-spin">‚è≥</span>
                <span
                  x-text="loadingTranslate ? 'Processando...' : 'Traduzir p/ Coreano'"
                ></span>
              </button>

              <div
                x-show="translatedResult"
                class="bg-purple-900/20 p-3 rounded-xl border border-purple-500/30 mt-2"
              >
                <p
                  class="text-[10px] text-purple-300 mb-1 uppercase tracking-wider font-bold"
                >
                  Toque para copiar:
                </p>
                <p
                  @click="copyResult"
                  class="text-lg font-medium text-white cursor-pointer active:scale-95 transition-transform selection:bg-purple-500 break-words"
                  x-text="translatedResult"
                ></p>
              </div>
            </div>
          </div>

          <button
            @click="chatOpen = !chatOpen"
            class="chat-bubble w-14 h-14 bg-gradient-to-br from-purple-600 to-army rounded-full flex items-center justify-center text-white shadow-lg hover:scale-110 active:scale-95 z-50"
          >
            <template x-if="!chatOpen">
              <svg class="w-6 h-6 fill-current" viewBox="0 0 24 24">
                <path
                  d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"
                />
              </svg>
            </template>
            <span x-show="chatOpen" class="text-xl font-bold">‚úï</span>
          </button>
        </div>
      </div>
    </main>

    <script>
      function studioManager() {
        return {
          liveUrl: "",
          isCapturing: false,
          currentSubtitle: "",
          ws: null,
          wsConnected: false,
          audioCtx: null,

          // Chat Reverso
          chatOpen: false,
          userComment: "",
          translatedResult: "",
          loadingTranslate: false,

          init() {
            this.connectWS();
          },

          async resumeAudioContext() {
            // Essencial para Mobile: Destrava o √°udio ap√≥s o primeiro clique do usu√°rio na tela
            if (this.audioCtx && this.audioCtx.state === "suspended") {
              await this.audioCtx.resume();
              console.log("AudioContext retomado com sucesso.");
            }
          },

          connectWS() {
            const protocol =
              window.location.protocol === "https:" ? "wss" : "ws";
            this.ws = new WebSocket(
              `${protocol}://${window.location.host}/ws/studio/1`
            );
            this.ws.binaryType = "arraybuffer";

            this.ws.onopen = () => {
              console.log("WS Conectado!");
              this.wsConnected = true;
            };

            this.ws.onclose = () => {
              console.log("WS Desconectado, tentando reconectar...");
              this.wsConnected = false;
              setTimeout(() => this.connectWS(), 3000);
            };

            this.ws.onmessage = (e) => {
              try {
                const data = JSON.parse(e.data);
                if (data.text) {
                  this.currentSubtitle = data.text;
                  // Limpa a legenda ap√≥s 5 segundos se n√£o vier outra, para n√£o poluir o mobile
                  setTimeout(() => {
                    if (this.currentSubtitle === data.text)
                      this.currentSubtitle = "";
                  }, 5000);
                }
              } catch (err) {
                console.error("Erro parse legenda:", err);
              }
            };
          },

          getEmbedUrl(url) {
            if (!url) return "";
            if (url.includes("youtube.com") || url.includes("youtu.be")) {
              let id = url.includes("v=")
                ? url.split("v=")[1].split("&")[0]
                : url.split("/").pop();
              // Adicionado 'mute=1' opcional e 'enablejsapi=1' para melhor controle mobile
              return `https://www.youtube.com/embed/${id}?autoplay=1&playsinline=1&modestbranding=1&rel=0&iv_load_policy=3&controls=1&enablejsapi=1`;
            }
            return url;
          },

          async toggleCapture() {
            if (!this.liveUrl) return alert("Insira o link da live primeiro!");

            try {
              const isMobile = /iPhone|iPad|iPod|Android/i.test(
                navigator.userAgent
              );
              let stream;

              if (isMobile) {
                // Captura otimizada para microfone mobile
                stream = await navigator.mediaDevices.getUserMedia({
                  audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                  },
                });
              } else {
                stream = await navigator.mediaDevices.getDisplayMedia({
                  audio: true,
                  video: { width: 1, height: 1 },
                });
              }

              this.isCapturing = true;
              this.startStreaming(stream);
            } catch (err) {
              console.error(err);
              alert(
                "Erro: Certifique-se de dar permiss√£o ao microfone e estar em uma conex√£o HTTPS."
              );
            }
          },

          startStreaming(stream) {
            // Configura√ß√£o para o Chirp v2 (16kHz Mono)
            this.audioCtx = new (window.AudioContext ||
              window.webkitAudioContext)({ sampleRate: 16000 });
            const source = this.audioCtx.createMediaStreamSource(stream);

            // ScriptProcessor ainda √© o mais compat√≠vel para manipula√ß√£o de bytes crus (PCM)
            const processor = this.audioCtx.createScriptProcessor(4096, 1, 1);

            source.connect(processor);
            processor.connect(this.audioCtx.destination);

            processor.onaudioprocess = (e) => {
              if (!this.isCapturing) return;

              const input = e.inputBuffer.getChannelData(0);
              const pcm = new Int16Array(input.length);

              for (let i = 0; i < input.length; i++) {
                pcm[i] = Math.max(-1, Math.min(1, input[i])) * 0x7fff;
              }

              if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                this.ws.send(pcm.buffer);
              }
            };
          },

          async translateComment() {
            if (!this.userComment) return;
            this.loadingTranslate = true;

            try {
              const res = await fetch("/api/translate-reverse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: this.userComment }),
              });

              if (!res.ok) throw new Error("Erro na API");

              const data = await res.json();
              this.translatedResult = data.korean;
            } catch (e) {
              console.error(e);
              this.translatedResult = "Erro ao traduzir. Tente novamente.";
            } finally {
              this.loadingTranslate = false;
            }
          },

          copyResult() {
            if (!this.translatedResult) return;

            // M√©todo robusto de c√≥pia para mobile
            const textArea = document.createElement("textarea");
            textArea.value = this.translatedResult;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand("copy");
              const original = this.translatedResult;
              this.translatedResult = "COPIADO! üíú";
              setTimeout(() => (this.translatedResult = original), 1500);
            } catch (err) {
              console.error("Erro ao copiar", err);
            }
            document.body.removeChild(textArea);
          },

          stopRecording() {
            this.isCapturing = false;
            this.currentSubtitle = "";
            if (this.audioCtx) this.audioCtx.close();
            window.location.reload();
          },
        };
      }
    </script>
  </body>
</html>
