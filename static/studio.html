<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>K-LENS | ARMY STUDIO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script
      defer
      src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Syncopate:wght@400;700&family=Inter:wght@400;900&display=swap"
      rel="stylesheet"
    />
    <style>
      [x-cloak] {
        display: none !important;
      }
      body {
        background: #000;
        color: white;
        font-family: "Inter", sans-serif;
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }
      .font-sync {
        font-family: "Syncopate", sans-serif;
      }

      .glass-purple {
        background: rgba(88, 28, 135, 0.25);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(168, 85, 247, 0.4);
      }

      .subtitle-overlay {
        text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000,
          2px 2px 0 #000, 0px 0px 15px rgba(0, 0, 0, 1);
        font-weight: 900;
        transition: opacity 0.3s ease;
      }

      @keyframes pulse-purple {
        0% {
          box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7);
        }
        70% {
          box-shadow: 0 0 0 15px rgba(168, 85, 247, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(168, 85, 247, 0);
        }
      }
      .live-indicator {
        animation: pulse-purple 2s infinite;
      }

      iframe {
        border: none;
      }

      .fullscreen-mode {
        position: fixed !important;
        inset: 0 !important;
        z-index: 100 !important;
        width: 100vw !important;
        height: 100vh !important;
        background: black;
      }

      .cursor-grab {
        cursor: grab;
      }
      .cursor-grabbing {
        cursor: grabbing;
      }
    </style>
  </head>
  <body
    x-data="studioManager()"
    class="select-none overflow-hidden"
    :class="isFull ? 'fullscreen-mode' : ''"
  >
    <aside
      x-show="!isCapturing"
      class="fixed inset-0 bg-black z-[70] flex flex-col justify-center items-center p-6 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-purple-900/30 via-black to-black"
    >
      <div class="w-full max-w-md text-center space-y-8">
        <div class="space-y-2">
          <div
            class="inline-block p-4 rounded-3xl bg-gradient-to-tr from-purple-600 to-fuchsia-500 mb-4 rotate-3 shadow-[0_0_40px_rgba(147,51,234,0.4)]"
          >
            <span class="font-sync font-bold text-4xl tracking-tighter"
              >K-LENS</span
            >
          </div>
          <p
            class="text-purple-400 font-bold tracking-[0.3em] text-[10px] uppercase"
          >
            Army Studio v2.0
          </p>
        </div>

        <div
          class="glass-purple p-8 rounded-[2.5rem] space-y-6 border-white/10"
        >
          <div class="text-left">
            <label
              class="text-[10px] font-black text-white/50 uppercase tracking-widest ml-2"
              >Link da Live YouTube</label
            >
            <input
              x-model="liveUrl"
              type="text"
              class="w-full bg-black/40 border border-purple-500/30 rounded-2xl p-4 mt-2 outline-none focus:border-purple-500 text-white transition-all placeholder:text-zinc-700"
              placeholder="https://youtube.com/live/..."
            />
          </div>

          <button
            @click="toggleCapture"
            class="w-full py-5 bg-white text-black rounded-2xl font-black uppercase text-xs tracking-[0.2em] hover:bg-purple-500 hover:text-white active:scale-95 transition-all shadow-2xl"
          >
            Entrar no EstÃºdio
          </button>
        </div>
      </div>
    </aside>

    <main
      id="app-canvas"
      class="w-screen h-screen relative bg-black flex items-center justify-center"
      :class="isFull ? 'fixed inset-0 z-[100]' : ''"
    >
      <template x-if="isCapturing">
        <div class="w-full h-full absolute inset-0">
          <iframe
            class="w-full h-full"
            :src="getEmbedUrl(liveUrl)"
            allow="autoplay; encrypted-media"
            allowfullscreen
          ></iframe>
        </div>
      </template>

      <div 
        x-show="isCapturing" 
        class="fixed bottom-24 left-6 z-[60] flex flex-col gap-3 pointer-events-auto"
      >
          <button 
            @click="sendManualClip('9:16')" 
            class="w-12 h-12 bg-purple-600 rounded-full flex items-center justify-center shadow-2xl active:scale-90 border-2 border-white/20"
          >
            <span class="text-[10px] font-black">9:16</span>
          </button>
          <button 
            @click="sendManualClip('16:9')" 
            class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-2xl active:scale-90 border-2 border-white/20"
          >
            <span class="text-[10px] font-black">16:9</span>
          </button>
      </div>

      <div
        x-show="isCapturing"
        class="fixed z-40 touch-none flex flex-col items-center pointer-events-auto"
        :style="`left: 50%; top: ${subPos.y}px; width: 100%; max-width: 95vw; transform: translateX(-50%);`"
        @mousedown="startDragSub"
        @touchstart="startDragSub"
      >
        <div
          class="subtitle-overlay px-6 text-center cursor-grab active:cursor-grabbing"
          :class="isDraggingSub ? 'opacity-50' : 'opacity-100'"
        >
          <span
            class="transition-all duration-500"
            :style="`font-size: ${fontSize}px; color: ${subTextColor};`"
          >
            <span
              x-text="currentSubtitle || 'ðŸ“¡ AGUARDANDO INTEGRAÃ‡ÃƒO...'"
            ></span>
          </span>
        </div>
      </div>

      <div
        class="fixed z-50 touch-none"
        :style="`left: ${chatPos.x}px; top: ${chatPos.y}px;`"
        x-show="isCapturing"
      >
        <div
          x-show="chatOpen"
          x-transition:enter="transition ease-out duration-200"
          x-transition:enter-start="opacity-0 scale-90 -translate-y-10"
          class="glass-purple w-[85vw] max-w-[320px] absolute bottom-20 right-0 rounded-[2rem] overflow-hidden shadow-[0_20px_50px_rgba(0,0,0,0.5)] border-white/20"
        >
          <div class="p-5 space-y-4 max-h-[70vh] overflow-y-auto">
            <div
              class="flex justify-between items-center border-b border-white/10 pb-2"
            >
              <span
                class="text-[9px] font-black text-purple-300 tracking-widest uppercase"
                >Ajustes do Studio</span
              >
              <button @click="chatOpen = false" class="text-white/40 p-1">
                âœ•
              </button>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div class="space-y-1">
                <label class="text-[8px] font-bold uppercase text-white/50">Formato</label>
                <select x-model="prodRatio" @change="updateProdConfig()" class="w-full bg-black/60 border border-white/10 rounded-lg p-2 text-[10px] outline-none">
                  <option value="9:16">TikTok (9:16)</option>
                  <option value="16:9">YouTube (16:9)</option>
                </select>
              </div>
              <div class="space-y-1">
                <label class="text-[8px] font-bold uppercase text-white/50">Tempo (s)</label>
                <input type="number" x-model="prodDuration" @change="updateProdConfig()" class="w-full bg-black/60 border border-white/10 rounded-lg p-2 text-[10px] outline-none" />
              </div>
            </div>

            <div class="space-y-1">
              <div
                class="flex justify-between text-[8px] font-bold uppercase text-white/50"
              >
                <span>Tamanho da Fonte</span>
                <span x-text="fontSize + 'px'"></span>
              </div>
              <input
                type="range"
                min="16"
                max="80"
                x-model="fontSize"
                class="w-full h-1 bg-purple-900 rounded-lg appearance-none cursor-pointer accent-purple-500"
              />
            </div>

            <textarea
              x-model="userComment"
              class="w-full bg-black/40 border border-white/5 rounded-2xl p-4 text-sm text-white outline-none focus:border-purple-500 resize-none h-24 transition-all"
              placeholder="Sua mensagem em PT-BR..."
            ></textarea>

            <button
              @click="translateComment"
              class="w-full py-4 bg-gradient-to-r from-purple-600 to-fuchsia-600 text-white rounded-xl font-black text-[10px] uppercase tracking-widest"
              :disabled="loadingTranslate"
            >
              <span
                x-text="loadingTranslate ? 'Traduzindo...' : 'Gerar em Coreano ðŸ‡°ðŸ‡·'"
              ></span>
            </button>

            <div
              x-show="translatedResult"
              x-cloak
              @click="copyResult"
              class="bg-white/10 p-4 rounded-2xl border border-white/10 cursor-pointer active:bg-white/20 transition-colors"
            >
              <p class="text-[8px] text-purple-300 font-bold uppercase mb-1">
                Toque para copiar:
              </p>
              <p
                class="text-base text-white font-medium leading-tight"
                x-text="translatedResult"
              ></p>
            </div>
          </div>
        </div>

        <button
          @mousedown="startDragChat"
          @touchstart="startDragChat"
          @click="if(!isDraggingChat) chatOpen = !chatOpen"
          class="w-14 h-14 md:w-16 md:h-16 bg-white text-black rounded-full flex items-center justify-center text-xl shadow-2xl live-indicator active:scale-90 transition-transform"
        >
          <span x-show="!chatOpen">ðŸ‡°ðŸ‡·</span>
          <span x-show="chatOpen" class="text-[10px] font-black uppercase"
            >Fechar</span
          >
        </button>
      </div>

      <div
        x-show="isCapturing"
        class="absolute top-6 left-6 right-6 flex justify-between items-center z-50 pointer-events-none"
      >
        <button
          @click="window.location.reload()"
          class="w-10 h-10 flex items-center justify-center glass-purple rounded-full text-white hover:bg-red-500 transition-all pointer-events-auto shadow-xl"
        >
          âœ•
        </button>

        <button
          @click="toggleFullscreen"
          class="px-4 py-2 glass-purple rounded-full text-[10px] font-black text-white uppercase tracking-widest pointer-events-auto flex items-center gap-2 border-white/20 active:scale-95 transition-all shadow-xl"
        >
          <span x-text="isFull ? 'Sair' : 'Tela Cheia K-LENS'"></span>
          <svg
            x-show="!isFull"
            class="w-3 h-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="3"
              d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"
            ></path>
          </svg>
        </button>
      </div>
    </main>

    <script>
      function studioManager() {
        return {
          liveUrl: "",
          isCapturing: false,
          currentSubtitle: "",
          ws: null,
          chatOpen: false,
          userComment: "",
          translatedResult: "",
          loadingTranslate: false,
          isFull: false,
          fontSize: 28,
          subTextColor: "#ffffff",
          
          prodRatio: "9:16",
          prodDuration: 61,

          subPos: { y: window.innerHeight * 0.8 },
          isDraggingSub: false,

          chatPos: {
            x: window.innerWidth - 80,
            y: window.innerHeight - 100,
          },
          isDraggingChat: false,
          dragOffset: { x: 0, y: 0 },

          init() {
            this.connectWS();
            window.addEventListener("mousemove", (e) => this.onGlobalMove(e));
            window.addEventListener("mouseup", () => this.endAllDrag());
            window.addEventListener(
              "touchmove",
              (e) => this.onGlobalMove(e.touches[0]),
              { passive: false }
            );
            window.addEventListener("touchend", () => this.endAllDrag());

            window.addEventListener("resize", () => {
              this.chatPos.x = window.innerWidth - 80;
              this.chatPos.y = window.innerHeight - 100;
            });
          },

          updateProdConfig() {
            if (this.ws?.readyState === WebSocket.OPEN) {
              this.ws.send(JSON.stringify({
                action: "update_config",
                ratio: this.prodRatio,
                duration: parseInt(this.prodDuration),
                live_url: this.liveUrl
              }));
            }
          },

          sendManualClip(ratio) {
            if (this.ws?.readyState === WebSocket.OPEN) {
                this.ws.send(JSON.stringify({
                    type: "MANUAL_CLIP",
                    ratio: ratio,
                    url: this.liveUrl,
                    label: "MANUAL_STUDIO"
                }));
                const oldText = this.currentSubtitle;
                this.currentSubtitle = "ðŸŽ¬ SOLICITANDO CORTE " + ratio + "...";
                setTimeout(() => { if(this.currentSubtitle.includes("SOLICITANDO")) this.currentSubtitle = oldText }, 3000);
            }
          },

          toggleFullscreen() {
            const el = document.documentElement;
            if (!this.isFull) {
              if (el.requestFullscreen) el.requestFullscreen();
              else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
              this.isFull = true;
            } else {
              if (document.exitFullscreen) document.exitFullscreen();
              else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
              this.isFull = false;
            }
          },

          startDragSub(e) {
            const clientY = e.clientY || e.touches[0].clientY;
            this.dragOffset.y = clientY - this.subPos.y;
            this.isDraggingSub = true;
          },

          startDragChat(e) {
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            this.dragOffset.x = clientX - this.chatPos.x;
            this.dragOffset.y = clientY - this.chatPos.y;
            this._tempDragChat = true;
            this.isDraggingChat = false;
          },

          onGlobalMove(e) {
            if (this.isDraggingSub) {
              let newY = e.clientY - this.dragOffset.y;
              this.subPos.y = Math.max(50, Math.min(window.innerHeight - 50, newY));
            }

            if (this._tempDragChat) {
              this.isDraggingChat = true;
              let newX = e.clientX - this.dragOffset.x;
              let newY = e.clientY - this.dragOffset.y;
              this.chatPos.x = Math.max(10, Math.min(window.innerWidth - 70, newX));
              this.chatPos.y = Math.max(10, Math.min(window.innerHeight - 70, newY));
            }
          },

          endAllDrag() {
            this.isDraggingSub = false;
            this._tempDragChat = false;
            setTimeout(() => (this.isDraggingChat = false), 150);
          },

          getEmbedUrl(url) {
            let id = "";
            if (url.includes("v=")) id = url.split("v=")[1].split("&")[0];
            else if (url.includes("live/")) id = url.split("live/")[1].split("?")[0];
            else if (url.includes("youtu.be/")) id = url.split("youtu.be/")[1].split("?")[0];
            else id = url.split("/").pop();
            return `https://www.youtube.com/embed/${id}?autoplay=1&mute=0&controls=0&modestbranding=1&rel=0`;
          },

          connectWS() {
            const protocol = window.location.protocol === "https:" ? "wss" : "ws";
            this.ws = new WebSocket(`${protocol}://${window.location.host}/ws/studio/1`);

            this.ws.onmessage = (e) => {
              const data = JSON.parse(e.data);
              if (data.type === "translation" && data.payload) {
                this.currentSubtitle = data.payload;

                if (data.payload.includes("!") || data.payload.includes("ðŸ’œ")) {
                  this.subTextColor = "#f0abfc";
                } else if (data.payload.includes("?")) {
                  this.subTextColor = "#93c5fd";
                } else {
                  this.subTextColor = "#ffffff";
                }

                setTimeout(() => {
                  if (this.currentSubtitle === data.payload)
                    this.currentSubtitle = "";
                }, 6000);
              }
            };
            this.ws.onclose = () => setTimeout(() => this.connectWS(), 3000);
          },

          async toggleCapture() {
            if (!this.liveUrl) return alert("Insira o Link da Live!");
            try {
              await navigator.mediaDevices.getUserMedia({ audio: true });
              this.isCapturing = true;
              setTimeout(() => {
                this.updateProdConfig();
                this.startAudioProcessing();
              }, 1000);
            } catch (err) {
              alert("Erro ao acessar microfone.");
            }
          },

          async startAudioProcessing() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
            const source = audioCtx.createMediaStreamSource(stream);
            const processor = audioCtx.createScriptProcessor(4096, 1, 1);
            source.connect(processor);
            processor.connect(audioCtx.destination);
            processor.onaudioprocess = (e) => {
              if (!this.isCapturing) return;
              const input = e.inputBuffer.getChannelData(0);
              const pcm = new Int16Array(input.length);
              for (let i = 0; i < input.length; i++) {
                pcm[i] = Math.max(-1, Math.min(1, input[i])) * 0x7fff;
              }
              if (this.ws?.readyState === WebSocket.OPEN)
                this.ws.send(pcm.buffer);
            };
          },

          async translateComment() {
            if (!this.userComment) return;
            this.loadingTranslate = true;
            try {
              const res = await fetch("/api/translate-reverse", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text: this.userComment }),
              });
              const data = await res.json();
              this.translatedResult = data.korean || "Erro";
            } catch (e) {
              this.translatedResult = "Erro";
            } finally {
              this.loadingTranslate = false;
            }
          },

          copyResult() {
            if (!this.translatedResult) return;
            navigator.clipboard.writeText(this.translatedResult);
            const ori = this.translatedResult;
            this.translatedResult = "COPIADO! ðŸ’œ";
            setTimeout(() => (this.translatedResult = ori), 1200);
          },
        };
      }
    </script>
  </body>
</html>